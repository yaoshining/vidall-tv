import { SettingContainer } from "../SettingContainer"
import { SettingsController } from "../SettingsController"
import { WebDAVClient, WebDAVConfig, WebDAVResource } from "../../../lib/WebDAVClient"
import promptAction from '@ohos.promptAction'
import { FileSourceDatabase } from "../../../db/files/FileSourceDatabase";
import { FileSourceDirectory } from "../../../db/models/FileSourceEntity";
import { FileSourceModel } from "../../../stores/files/FileSourceModel";
import { FileSourceStore } from "../../../stores/files/FileSourceStore";

/**
 * é¢åŒ…å±‘é¡¹æ¥å£
 */
interface BreadcrumbItem {
  name: string;
  path: string;
}

@ComponentV2
struct DirectorySelectorBuilderComponent {
  @Consumer('settingsController') controller: SettingsController = new SettingsController()

  // çŠ¶æ€å˜é‡
  @Local directories: WebDAVResource[] = []
  @Local isLoading: boolean = false
  @Local isSaving: boolean = false
  @Local errorMessage: string = ''
  @Local currentPath: string = '/'
  // path -> customNameï¼ˆç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä½¿ç”¨é»˜è®¤åï¼‰
  @Local selectedMap: Map<string, string> = new Map()
  @Local isAllSelected: boolean = false
  fileSourceModel: FileSourceModel = FileSourceStore.getState()

  // å‘½åå¼¹çª—çŠ¶æ€
  @Local showNameDialog: boolean = false
  @Local pendingPath: string = ''          // å¾…å‘½åçš„è·¯å¾„
  @Local pendingDefaultName: string = ''   // é»˜è®¤åï¼ˆæ–‡ä»¶å¤¹åï¼‰
  @Local inputCustomName: string = ''      // å¼¹çª—è¾“å…¥æ¡†å†…å®¹
  private nameInputController: TextInputController = new TextInputController()

  // ç§æœ‰å˜é‡
  private pathHistory: string[] = ['/']
  private sourceId: number = 0
  private webdavClient: WebDAVClient | null = null
  private previousSelectedMap: Map<string, string> = new Map()
  // æš‚å­˜å–æ¶ˆå‹¾é€‰çš„è·¯å¾„â†’åå­—ï¼Œä¸‹æ¬¡å†å‹¾é€‰æ—¶å¸¦å›
  private uncheckedMap: Map<string, string> = new Map()

  aboutToAppear(): void {
    this.controller.setBackHandler(() => this.handleBackPressed())
    this.initializeSelector()
  }

  aboutToDisappear(): void {
    this.controller.setBackHandler(null)
  }

  /**
   * åˆå§‹åŒ–é€‰æ‹©å™¨
   */
  private async initializeSelector(): Promise<void> {
    try {
      // ä»å‚æ•°è·å–é…ç½®
      const params = this.controller.params
      if (!params) {
        this.errorMessage = 'ç¼ºå°‘å¿…è¦å‚æ•°'
        return
      }

      this.sourceId = params['sourceId'] as number
      const baseUrl = params['baseUrl'] as string
      const username = params['username'] as string
      const password = params['password'] as string

      if (!this.sourceId || !baseUrl || !username || !password) {
        this.errorMessage = 'é…ç½®å‚æ•°ä¸å®Œæ•´'
        return
      }

      // åˆ›å»º WebDAV å®¢æˆ·ç«¯
      const config: WebDAVConfig = {
        baseUrl: baseUrl,
        username: username,
        password: password,
        timeout: 10000
      }
      this.webdavClient = new WebDAVClient(config)

      // åŠ è½½å·²ä¿å­˜çš„ç›®å½•
      await this.loadSelectedDirectories()

      // åŠ è½½æ ¹ç›®å½•
      await this.loadCurrentDirectory()
    } catch (error) {
      console.error('DirectorySelector: Failed to initialize', JSON.stringify(error))
      this.errorMessage = 'åˆå§‹åŒ–å¤±è´¥ï¼š' + JSON.stringify(error)
    }
  }

  /**
   * åŠ è½½å·²ä¿å­˜çš„ç›®å½•è·¯å¾„
   */
  private async loadSelectedDirectories(): Promise<void> {
    try {
      const database = FileSourceDatabase.getInstance()
      const directories = await database.getDirectoriesBySourceId(this.sourceId)

      directories.forEach((dir: FileSourceDirectory) => {
        this.selectedMap.set(dir.directoryPath, dir.customName ?? '')
      })

      // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†"å…¨éƒ¨æ–‡ä»¶å¤¹"ï¼ˆæ ¹è·¯å¾„æ ‡è®°ï¼‰
      if (this.selectedMap.has('/') && this.selectedMap.size === 1) {
        // åªæœ‰ä¸€ä¸ªè·¯å¾„ä¸”æ˜¯æ ¹è·¯å¾„ï¼Œè¯´æ˜ç”¨æˆ·ä¹‹å‰é€‰æ‹©äº†"å…¨éƒ¨æ–‡ä»¶å¤¹"
        this.isAllSelected = true
        console.info('DirectorySelector: Detected "all folders" selection')
      }

      console.info(`DirectorySelector: Loaded ${this.selectedMap.size} selected paths`)
    } catch (error) {
      console.error('DirectorySelector: Failed to load selected directories', JSON.stringify(error))
      // ä¸é˜»æ–­æµç¨‹ï¼Œç»§ç»­æ‰§è¡Œ
    }
  }

  /**
   * åŠ è½½å½“å‰ç›®å½•çš„æ–‡ä»¶å¤¹åˆ—è¡¨
   */
  private async loadCurrentDirectory(): Promise<void> {
    if (!this.webdavClient) {
      this.errorMessage = 'WebDAV å®¢æˆ·ç«¯æœªåˆå§‹åŒ–'
      return
    }

    this.isLoading = true
    this.errorMessage = ''

    try {
      console.info('DirectorySelector: Loading directory:', this.currentPath)

      const resources = await this.webdavClient.listDirectory(this.currentPath)

      // è¿‡æ»¤å‡ºæ–‡ä»¶å¤¹ï¼Œå¹¶æ’é™¤ç¬¬ä¸€æ¡ï¼ˆå½“å‰ç›®å½•æœ¬èº«ï¼‰
      // WebDAV PROPFIND depth=1 ä¼šè¿”å›å½“å‰ç›®å½•ä½œä¸ºç¬¬ä¸€æ¡ç»“æœ
      this.directories = resources
        .filter((item: WebDAVResource) => item.isCollection)
        .filter((item: WebDAVResource, index: number) => index > 0)

      console.info(`DirectorySelector: Found ${this.directories.length} directories`)

      if (this.directories.length === 0) {
        this.errorMessage = 'æ­¤ç›®å½•ä¸‹æ²¡æœ‰æ–‡ä»¶å¤¹'
      }
    } catch (error) {
      console.error('DirectorySelector: Failed to load directory', JSON.stringify(error))
      this.errorMessage = 'åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'
    } finally {
      this.isLoading = false
    }
  }

  /**
   * è¿›å…¥å­ç›®å½•
   */
  private handleEnterDirectory(directory: WebDAVResource): void {
    // å°†å½“å‰è·¯å¾„åŠ å…¥å†å²
    this.pathHistory.push(this.currentPath)

    // æ„é€ æ–°è·¯å¾„
    const separator = this.currentPath.endsWith('/') ? '' : '/'
    this.currentPath = this.currentPath + separator + directory.displayName

    console.info('DirectorySelector: Enter directory:', this.currentPath)

    // åŠ è½½æ–°ç›®å½•
    this.loadCurrentDirectory()
  }

  /**
   * è¿”å›ä¸Šä¸€çº§ç›®å½•
   */
  private handleGoBack(): void {
    if (this.pathHistory.length <= 1) {
      return
    }

    // ä»å†å²ä¸­å¼¹å‡ºæœ€åä¸€ä¸ªè·¯å¾„ï¼Œè¿™å°±æ˜¯ä¸Šä¸€çº§ç›®å½•
    const previousPath = this.pathHistory.pop()

    // è®¾ç½®å½“å‰è·¯å¾„ä¸ºå¼¹å‡ºçš„è·¯å¾„
    if (previousPath) {
      this.currentPath = previousPath
      console.info('DirectorySelector: Go back to:', this.currentPath)

      // åŠ è½½ç›®å½•
      this.loadCurrentDirectory()
    }
  }

  /**
   * è·å–æ–‡ä»¶å¤¹å®Œæ•´è·¯å¾„
   */
  private getFullPath(directory: WebDAVResource): string {
    const separator = this.currentPath.endsWith('/') ? '' : '/'
    return this.currentPath + separator + directory.displayName
  }

  /**
   * å‹¾é€‰ checkbox â€”â€” å¼¹å‡ºå‘½åå¼¹çª—
   */
  private handleCheckboxChange(directory: WebDAVResource): void {
    const fullPath = this.getFullPath(directory)
    if (this.selectedMap.has(fullPath)) {
      // å·²é€‰ä¸­ â†’ å–æ¶ˆé€‰ä¸­ï¼šæŠŠå½“å‰åå­—å­˜å…¥ uncheckedMapï¼Œä» selectedMap ç§»é™¤
      const savedName = this.selectedMap.get(fullPath) ?? ''
      this.uncheckedMap.set(fullPath, savedName)
      this.selectedMap.delete(fullPath)
      this.selectedMap = new Map(this.selectedMap)
    } else {
      // æœªé€‰ä¸­ â†’ å¼¹å‡ºå‘½åå¼¹çª—
      this.pendingPath = fullPath
      this.pendingDefaultName = directory.displayName
      // ä¼˜å…ˆç”¨ä¸Šæ¬¡ä¿å­˜çš„åå­—ï¼Œå¦åˆ™é»˜è®¤ä¸ºæ–‡ä»¶å¤¹å
      this.inputCustomName = this.uncheckedMap.get(fullPath) ?? directory.displayName
      this.showNameDialog = true
    }
  }

  /**
   * ç¡®è®¤å‘½åå¼¹çª—
   */
  private confirmNameDialog(): void {
    // åå­—ä¸ºç©ºæ—¶å›é€€åˆ°æ–‡ä»¶å¤¹å
    const finalName = this.inputCustomName.trim().length > 0
      ? this.inputCustomName.trim()
      : this.pendingDefaultName
    this.selectedMap.set(this.pendingPath, finalName)
    this.selectedMap = new Map(this.selectedMap)
    // ç¡®è®¤åæ¸…é™¤æš‚å­˜
    this.uncheckedMap.delete(this.pendingPath)
    this.showNameDialog = false
  }

  /**
   * å–æ¶ˆå‘½åå¼¹çª— â€”â€” ä¸ä¿å­˜ï¼Œä¸æ¸…é™¤ uncheckedMap æš‚å­˜
   */
  private cancelNameDialog(): void {
    this.showNameDialog = false
    this.pendingPath = ''
    this.inputCustomName = ''
  }

  private isSelected(directory: WebDAVResource): boolean {
    return this.selectedMap.has(this.getFullPath(directory))
  }

  /**
   * å®Œæˆé€‰æ‹©å¹¶ä¿å­˜
   */
  private async handleComplete(): Promise<void> {
    this.isSaving = true

    try {
      const database = FileSourceDatabase.getInstance()
      // åˆ é™¤æ—§è®°å½•
      await database.deleteDirectoriesBySourceId(this.sourceId)

      const dirEntries: FileSourceDirectory[] = []
      this.selectedMap.forEach((customName: string, path: string) => {
        const entry: FileSourceDirectory = {
          sourceId: this.sourceId,
          directoryPath: path,
          customName: customName.length > 0 ? customName : undefined
        }
        dirEntries.push(entry)
      })

      // æ’å…¥æ–°é€‰æ‹©
      await database.insertDirectories(this.sourceId, dirEntries)
      await this.fileSourceModel.loadFileSources(true)
      // ä¿å­˜æˆåŠŸåæ¸…é™¤æ‰€æœ‰æš‚å­˜
      this.uncheckedMap.clear()

      console.info(`DirectorySelector: Saved ${dirEntries.length} directories`)

      this.getUIContext().getPromptAction().showToast({
        message: 'ä¿å­˜æˆåŠŸ'
      } as promptAction.ShowToastOptions)

      // è¿”å›æ–‡ä»¶æºåˆ—è¡¨
      this.controller.popType()
    } catch (error) {
      console.error('DirectorySelector: Failed to save', JSON.stringify(error))

      AlertDialog.show({
        title: 'ä¿å­˜å¤±è´¥',
        message: 'ä¿å­˜ç›®å½•é€‰æ‹©å¤±è´¥ï¼š' + JSON.stringify(error),
        primaryButton: {
          value: 'ç¡®å®š',
          action: () => {}
        }
      })
    } finally {
      this.isSaving = false
    }
  }

  /**
   * å–æ¶ˆé€‰æ‹©
   */
  private handleCancel(): void {
    // å¦‚æœåœ¨éæ ¹ç›®å½•ï¼Œè¿”å›ä¸Šä¸€çº§
    if (this.pathHistory.length > 1) {
      this.handleGoBack()
    } else {
      // åœ¨æ ¹ç›®å½•æ‰è¿”å›æ–‡ä»¶æºåˆ—è¡¨
      this.controller.popType()
    }
  }

  /**
   * å¤„ç†è¿”å›é”®æŒ‰ä¸‹äº‹ä»¶
   * @returns true è¡¨ç¤ºæ¶ˆè´¹äº‹ä»¶ï¼Œfalse è¡¨ç¤ºä¸æ¶ˆè´¹
   */
  private handleBackPressed(): boolean {
    // å¦‚æœåœ¨éæ ¹ç›®å½•ï¼Œè¿”å›ä¸Šä¸€çº§
    if (this.pathHistory.length > 1) {
      this.handleGoBack()
      return true // æ¶ˆè´¹äº‹ä»¶ï¼Œä¸ç»§ç»­ä¼ é€’
    }
    // åœ¨æ ¹ç›®å½•æ—¶è¿”å› falseï¼Œè®©ä¸Šå±‚å¤„ç†ï¼ˆè¿”å›æ–‡ä»¶æºåˆ—è¡¨ï¼‰
    return false
  }

  /**
   * è·å–é¢åŒ…å±‘è·¯å¾„æ•°ç»„
   * å°†å½“å‰è·¯å¾„è§£æä¸ºé¢åŒ…å±‘è·¯å¾„æ®µ
   */
  private getBreadcrumbs(): BreadcrumbItem[] {
    const breadcrumbs: BreadcrumbItem[] = []

    // æ·»åŠ æ ¹ç›®å½•
    const rootItem: BreadcrumbItem = { name: 'æ ¹ç›®å½•', path: '/' }
    breadcrumbs.push(rootItem)

    // å¦‚æœå½“å‰è·¯å¾„ä¸æ˜¯æ ¹ç›®å½•ï¼Œè§£æè·¯å¾„
    if (this.currentPath !== '/') {
      const segments = this.currentPath.split('/').filter(seg => seg.length > 0)
      let accumulatedPath = ''

      segments.forEach((segment) => {
        accumulatedPath += '/' + segment
        const item: BreadcrumbItem = {
          name: segment,
          path: accumulatedPath
        }
        breadcrumbs.push(item)
      })
    }

    return breadcrumbs
  }

  /**
   * å¤„ç†é¢åŒ…å±‘ç‚¹å‡»ï¼Œè·³è½¬åˆ°æŒ‡å®šè·¯å¾„
   */
  private handleBreadcrumbClick(targetPath: string): void {
    if (targetPath === this.currentPath) {
      // ç‚¹å‡»çš„æ˜¯å½“å‰è·¯å¾„ï¼Œä¸åšå¤„ç†
      return
    }

    // é‡å»ºè·¯å¾„å†å²æ ˆ
    // æ‰¾åˆ°ç›®æ ‡è·¯å¾„åœ¨å½“å‰å†å²ä¸­çš„ä½ç½®
    const targetIndex = this.pathHistory.indexOf(targetPath)

    if (targetIndex !== -1) {
      // ç›®æ ‡è·¯å¾„åœ¨å†å²æ ˆä¸­ï¼Œç§»é™¤ä¹‹åçš„æ‰€æœ‰è·¯å¾„
      this.pathHistory = this.pathHistory.slice(0, targetIndex + 1)
    } else {
      // ç›®æ ‡è·¯å¾„ä¸åœ¨å†å²æ ˆä¸­ï¼ˆå¯èƒ½æ˜¯é€šè¿‡é¢åŒ…å±‘è·³è½¬çš„ï¼‰
      // é‡æ–°æ„å»ºå†å²æ ˆï¼šæ ¹æ®ç›®æ ‡è·¯å¾„æ„å»ºä»æ ¹åˆ°ç›®æ ‡çš„è·¯å¾„åºåˆ—
      const segments = targetPath.split('/').filter(seg => seg.length > 0)
      this.pathHistory = ['/']

      let accumulatedPath = ''
      segments.forEach((segment) => {
        accumulatedPath += '/' + segment
        this.pathHistory.push(accumulatedPath)
      })
    }

    // æ›´æ–°å½“å‰è·¯å¾„
    this.currentPath = targetPath

    console.info('DirectorySelector: Jump to breadcrumb:', targetPath)

    // åŠ è½½ç›®æ ‡ç›®å½•
    this.loadCurrentDirectory()
  }

  /**
   * å…¨éƒ¨é€‰æ‹©æˆ–å–æ¶ˆé€‰æ‹©
   */
  private handleSelectAll(): void {
    if (this.isAllSelected) {
      // å–æ¶ˆå…¨é€‰ - æ¢å¤ä¹‹å‰çš„é€‰æ‹©çŠ¶æ€
      this.selectedMap = new Map(this.previousSelectedMap)
      this.isAllSelected = false
      console.info('DirectorySelector: Deselected all folders, restored previous selection')
    } else {
      // å…¨é€‰ - å¤‡ä»½å½“å‰é€‰æ‹©ï¼Œç„¶ååªä¿å­˜æ ¹è·¯å¾„æ ‡è®°
      this.previousSelectedMap = new Map(this.selectedMap)

      // æ¸…ç©ºå½“å‰é€‰æ‹©ï¼Œåªä¿ç•™æ ¹è·¯å¾„æ ‡è®°è¡¨ç¤º"å…¨éƒ¨æ–‡ä»¶å¤¹"
      this.selectedMap = new Map([[' /', '']])
      this.isAllSelected = true
      console.info('DirectorySelector: Selected all folders (saved as root path)')
    }
  }

  private getCustomName(directory: WebDAVResource): string {
    return this.selectedMap.get(this.getFullPath(directory)) ?? ''
  }

  private hasCustomName(directory: WebDAVResource): boolean {
    return this.getCustomName(directory).length > 0
  }

  build() {
    Stack() {
      SettingContainer({ title: "é€‰æ‹©æ–‡ä»¶å¤¹" }) {
        Column() {
          // é¡¶éƒ¨é¢åŒ…å±‘
          Column() {
            // è¿”å›æŒ‰é’®è¡Œ
            if (this.pathHistory.length > 1) {
              Row() {
                Button("â† è¿”å›")
                  .fontSize(14)
                  .height(32)
                  .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
                  .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
                  .onClick(() => this.handleGoBack())
                  .enabled(!this.isLoading && !this.isSaving)
              }
              .width('100%')
              .margin({ bottom: 8 })
            }

            // é¢åŒ…å±‘å¯¼èˆª
            Scroll() {
              Row({ space: 4 }) {
                ForEach(this.getBreadcrumbs(), (breadcrumb: BreadcrumbItem, index: number) => {
                  Row({ space: 4 }) {
                    // é¢åŒ…å±‘é¡¹
                    Text(breadcrumb.name)
                      .fontSize(14)
                      .fontColor(breadcrumb.path === this.currentPath ?
                        $r('sys.color.ohos_id_color_emphasize') :
                        $r('sys.color.ohos_id_color_text_secondary'))
                      .fontWeight(breadcrumb.path === this.currentPath ? FontWeight.Medium : FontWeight.Normal)
                      .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                      .borderRadius(4)
                      .backgroundColor(breadcrumb.path === this.currentPath ?
                        $r('sys.color.ohos_id_color_click_effect') :
                        Color.Transparent)
                      .onClick(() => {
                        if (!this.isLoading && !this.isSaving) {
                          this.handleBreadcrumbClick(breadcrumb.path)
                        }
                      })
                      .enabled(!this.isLoading && !this.isSaving)

                    // åˆ†éš”ç¬¦ï¼ˆæœ€åä¸€é¡¹ä¸æ˜¾ç¤ºï¼‰
                    if (index < this.getBreadcrumbs().length - 1) {
                      Text('/')
                        .fontSize(14)
                        .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                    }
                  }
                }, (breadcrumb: BreadcrumbItem) => breadcrumb.path)
              }
              .padding({ left: 4, right: 4 })
            }
            .width('100%')
            .scrollable(ScrollDirection.Horizontal)
            .scrollBar(BarState.Off)
          }
          .width('100%')
          .padding(12)
          .backgroundColor($r('sys.color.ohos_id_color_background'))

          // å†…å®¹åŒº
          Column() {
            if (this.isLoading) {
              // åŠ è½½çŠ¶æ€
              Row() {
                LoadingProgress()
                  .width(30).height(30)
                  .color($r('sys.color.ohos_id_color_emphasize'))
              }
              .width('100%').padding({ top: 40 })
              .justifyContent(FlexAlign.Center)
            } else if (this.errorMessage) {
              // é”™è¯¯æç¤º
              Row() {
                Text(this.errorMessage)
                  .fontSize(14)
                  .fontColor($r('sys.color.ohos_id_color_text_secondary'))
              }
              .width('100%').padding({ top: 40 })
              .justifyContent(FlexAlign.Center)
            } else {
              Scroll() {
                Column({ space: 0 }) {
                  // å…¨éƒ¨æ–‡ä»¶å¤¹é€‰é¡¹
                  Row() {
                    Text('ğŸ“‚').fontSize(24).margin({ right: 12 })
                    Text('å…¨éƒ¨æ–‡ä»¶å¤¹')
                      .fontSize(16)
                      .fontColor($r('sys.color.ohos_id_color_emphasize'))
                      .fontWeight(FontWeight.Medium)
                      .layoutWeight(1)
                    Checkbox()
                      .select(this.isAllSelected)
                      .selectedColor($r('sys.color.ohos_id_color_emphasize'))
                      .onChange(() => { this.handleSelectAll() })
                  }
                  .width('100%').height(56)
                  .padding({ left: 16, right: 16 })
                  .border({ width: { bottom: 2 }, color: $r('sys.color.ohos_id_color_emphasize') })

                  // æ–‡ä»¶å¤¹åˆ—è¡¨
                  ForEach(this.directories, (directory: WebDAVResource) => {
                    Row() {
                      Text('ğŸ“').fontSize(24).margin({ right: 12 })
                      Column() {
                        Text(directory.displayName)
                          .fontSize(16)
                          .fontColor($r('sys.color.ohos_id_color_text_primary'))
                          .maxLines(1)
                          .textOverflow({ overflow: TextOverflow.Ellipsis })
                        // æ˜¾ç¤ºè‡ªå®šä¹‰åï¼ˆå¦‚æœæœ‰ï¼‰
                        if (this.isSelected(directory) && this.hasCustomName(directory)) {
                          Text('åˆ«åï¼š' + this.getCustomName(directory))
                            .fontSize(12)
                            .fontColor($r('sys.color.ohos_id_color_text_secondary'))
                            .maxLines(1)
                            .textOverflow({ overflow: TextOverflow.Ellipsis })
                        }
                      }
                      .layoutWeight(1)
                      .alignItems(HorizontalAlign.Start)

                      if (!this.isAllSelected) {
                        Checkbox()
                          .select(this.isSelected(directory))
                          .selectedColor($r('sys.color.ohos_id_color_emphasize'))
                          .onChange(() => { this.handleCheckboxChange(directory) })
                      }
                    }
                    .width('100%').height(56)
                    .padding({ left: 16, right: 16 })
                    .onClick(() => {
                      if (!this.isAllSelected) {
                        this.handleEnterDirectory(directory)
                      }
                    })
                    .border({ width: { bottom: 1 }, color: $r('sys.color.ohos_id_color_list_separator') })
                    .opacity(this.isAllSelected ? 0.5 : 1)
                  }, (directory: WebDAVResource) => directory.href)
                }
              }
              .width('100%')
              .layoutWeight(1)
              .scrollBar(BarState.Auto)
              .align(Alignment.Top)
            }
          }
          .layoutWeight(1)
          .alignItems(HorizontalAlign.Start)

          // åº•éƒ¨æ“ä½œæ 
          Row({ space: 12 }) {
            Button('å–æ¶ˆ')
              .fontSize(16)
              .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
              .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
              .layoutWeight(1)
              .onClick(() => this.handleCancel())
              .enabled(!this.isSaving)

            Button('å®Œæˆ')
              .fontSize(16)
              .backgroundColor($r('sys.color.ohos_id_color_emphasize'))
              .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
              .layoutWeight(1)
              .onClick(() => this.handleComplete())
              .enabled(!this.isSaving)
          }
          .width('100%')
          .padding(16)
        }
        .width('100%').height('100%')
      }

      // è‡ªå®šä¹‰å‘½åå¼¹çª—ï¼ˆè’™å±‚ + å¼¹çª—å¡ç‰‡ï¼‰
      if (this.showNameDialog) {
        Column() {
          Column({ space: 16 }) {
            Text('è‡ªå®šä¹‰æ–‡ä»¶å¤¹åç§°')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .fontColor($r('sys.color.ohos_id_color_text_primary'))

            Text('æ–‡ä»¶å¤¹ï¼š' + this.pendingDefaultName)
              .fontSize(13)
              .fontColor($r('sys.color.ohos_id_color_text_secondary'))
              .maxLines(1)
              .textOverflow({ overflow: TextOverflow.Ellipsis })

            TextInput({
              placeholder: this.pendingDefaultName,
              text: this.inputCustomName,
              controller: this.nameInputController
            })
              .onChange((val: string) => { this.inputCustomName = val })
              .onAppear(() => {
                // å¼¹çª—å‡ºç°åè‡ªåŠ¨è¯·æ±‚ç„¦ç‚¹
                this.nameInputController.caretPosition(this.inputCustomName.length)
                focusControl.requestFocus('nameInput')
              })
              .id('nameInput')
              .defaultFocus(true)
              .fontSize(16)
              .borderRadius(8)

            Row({ space: 12 }) {
              Button('å–æ¶ˆ')
                .layoutWeight(1)
                .backgroundColor($r('sys.color.ohos_id_color_button_normal'))
                .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
                .onClick(() => { this.cancelNameDialog() })
              Button('ç¡®å®š')
                .layoutWeight(1)
                .backgroundColor($r('sys.color.ohos_id_color_emphasize'))
                .fontColor($r('sys.color.ohos_id_color_text_primary_contrary'))
                .onClick(() => { this.confirmNameDialog() })
            }
            .width('100%')
          }
          .width('80%')
          .padding(24)
          .borderRadius(16)
          .backgroundColor($r('sys.color.ohos_id_color_background'))
          .shadow({ radius: 20, color: '#33000000', offsetX: 0, offsetY: 4 })
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#80000000')
        .onClick(() => {
          // ç‚¹å‡»è’™å±‚ä¸å…³é—­ï¼Œé¿å…è¯¯è§¦
        })
      }
    }
    .width('100%')
    .height('100%')
  }
}

@Builder
export function DirectorySelectorBuilder() {
  DirectorySelectorBuilderComponent()
}
