import { WebDAVResource } from "../../../lib/WebDAVClient";
import { FileExplorerController } from "./FileExplorerController";

/**
 * æ–‡ä»¶ç‚¹å‡»äº‹ä»¶æ•°æ®
 */
export interface FileClickEvent {
  resource: WebDAVResource;
  fullPath: string;
}

/**
 * è·¯å¾„å¯¼èˆªé¡¹
 */
interface PathItem {
  name: string;
  path: string;
}

interface ColorsInterface {
  background: string;
  surface: string;
  surfaceVariant: string;
  primaryText: string;
  secondaryText: string;
  tertiaryText: string;
  accent: string;
  divider: string;
  hover: string;
  button: string;
}

@ComponentV2
export struct FileExplorer {
  @Param @Require controller: FileExplorerController
  @Event onFileClick: (event: FileClickEvent) => void = () => {};
  @Event onBack: () => boolean = () => true;

  // æ·±è‰²ä¸»é¢˜é¢œè‰²å®šä¹‰
  private readonly COLORS: ColorsInterface = {
    background: '#000000',           // ä¸»èƒŒæ™¯è‰²
    surface: '#1C1C1E',             // è¡¨é¢è‰²
    surfaceVariant: '#2C2C2E',      // è¡¨é¢å˜ä½“è‰²
    primaryText: '#FFFFFF',         // ä¸»æ–‡æœ¬è‰²
    secondaryText: '#EBEBF5',       // æ¬¡è¦æ–‡æœ¬è‰²
    tertiaryText: '#98989D',        // ä¸‰çº§æ–‡æœ¬è‰²
    accent: '#0A84FF',              // å¼ºè°ƒè‰²ï¼ˆè“è‰²ï¼‰
    divider: '#38383A',             // åˆ†å‰²çº¿è‰²
    hover: '#3A3A3C',               // æ‚¬åœè‰²
    button: '#48484A'               // æŒ‰é’®è‰²
  };

  /**
   * èŽ·å–è·¯å¾„å¯¼èˆªé¡¹
   */
  @Computed
  get pathItems(): PathItem[] {
    const items: PathItem[] = [];

    items.push({
      name: 'æ ¹ç›®å½•',
      path: '/'
    });

    if (this.controller.currentPath === '/') {
      return items;
    }

    const parts = this.controller.currentPath.split('/').filter(p => p.length > 0);
    let accumulatedPath = '';

    for (let i = 0; i < parts.length; i++) {
      accumulatedPath += '/' + parts[i];
      items.push({
        name: decodeURIComponent(parts[i]),
        path: accumulatedPath
      });
    }

    return items;
  }

  private changeSortField(field: 'name' | 'size' | 'date'): void {
    if (this.controller.sortField === field) {
      this.controller.sortAscending = !this.controller.sortAscending;
    } else {
      this.controller.sortField = field;
      this.controller.sortAscending = true;
    }
  }

  private getSortIcon(field: 'name' | 'size' | 'date'): string {
    if (this.controller.sortField !== field) {
      return '';
    }
    return this.controller.sortAscending ? 'â†‘' : 'â†“';
  }

  private handleResourceClick(resource: WebDAVResource): void {
    if (resource.isCollection) {
      let newPath = this.controller.currentPath;
      if (!newPath.endsWith('/')) {
        newPath += '/';
      }
      newPath += resource.displayName;

      this.controller.onFolderChange(newPath);
    } else {
      const fullPath = this.controller.currentPath.endsWith('/')
        ? this.controller.currentPath + resource.displayName
        : this.controller.currentPath + '/' + resource.displayName;

      this.onFileClick({
        resource: resource,
        fullPath: fullPath
      });
    }
  }

  private handlePathClick(path: string): void {
    if (path !== this.controller.currentPath) {
      this.controller.onFolderChange(path);
    }
  }

  private formatFileSize(bytes?: number): string {
    if (bytes === undefined) return '-';

    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
    if (bytes < 1024 * 1024 * 1024) return `${(bytes / 1024 / 1024).toFixed(2)} MB`;
    return `${(bytes / 1024 / 1024 / 1024).toFixed(2)} GB`;
  }

  private formatDate(dateStr?: string): string {
    if (!dateStr) return '-';

    try {
      const date = new Date(dateStr);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');

      return `${year}-${month}-${day} ${hours}:${minutes}`;
    } catch (error) {
      return dateStr;
    }
  }

  private getFileIcon(resource: WebDAVResource): string {
    if (resource.isCollection) {
      return 'ðŸ“';
    }

    const fileName = resource.displayName.toLowerCase();

    if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') ||
    fileName.endsWith('.png') || fileName.endsWith('.gif') ||
    fileName.endsWith('.bmp') || fileName.endsWith('.webp')) {
      return 'ðŸ–¼ï¸';
    }

    if (fileName.endsWith('.mp4') || fileName.endsWith('.avi') ||
    fileName.endsWith('.mkv') || fileName.endsWith('.mov')) {
      return 'ðŸŽ¬';
    }

    if (fileName.endsWith('.mp3') || fileName.endsWith('.wav') ||
    fileName.endsWith('.flac') || fileName.endsWith('.aac')) {
      return 'ðŸŽµ';
    }

    if (fileName.endsWith('.pdf')) {
      return 'ðŸ“•';
    }

    if (fileName.endsWith('.doc') || fileName.endsWith('.docx') ||
    fileName.endsWith('.txt') || fileName.endsWith('.md')) {
      return 'ðŸ“„';
    }

    if (fileName.endsWith('.xls') || fileName.endsWith('.xlsx') ||
    fileName.endsWith('.csv')) {
      return 'ðŸ“Š';
    }

    if (fileName.endsWith('.zip') || fileName.endsWith('.rar') ||
    fileName.endsWith('.7z') || fileName.endsWith('.tar')) {
      return 'ðŸ“¦';
    }

    return 'ðŸ“„';
  }

  build() {
    Column() {
      // é¡¶éƒ¨å·¥å…·æ 
      Row() {
        Button('è¿”å›ž')
          .fontSize(16)
          .height(40)
          .backgroundColor(this.COLORS.button)
          .fontColor(this.COLORS.accent)
          .onClick(() => {
            this.controller.handleBack();
          })
          .margin({ right: 10 })

        Text(`æ–‡ä»¶ï¼š${this.controller.sortedResources.length}`)
          .fontSize(14)
          .fontColor(this.COLORS.tertiaryText)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 12, bottom: 12 })
      .backgroundColor(this.COLORS.surface)

      // è·¯å¾„å¯¼èˆª
      Scroll() {
        Row() {
          ForEach(this.pathItems, (item: PathItem, index: number) => {
            Row() {
              Text(item.name)
                .fontSize(14)
                .fontColor(index === this.pathItems.length - 1
                  ? this.COLORS.primaryText
                  : this.COLORS.accent)
                .fontWeight(index === this.pathItems.length - 1
                  ? FontWeight.Bold
                  : FontWeight.Normal)
                .onClick(() => {
                  if (index !== this.pathItems.length - 1) {
                    this.handlePathClick(item.path);
                  }
                })

              if (index < this.pathItems.length - 1) {
                Text(' / ')
                  .fontSize(14)
                  .fontColor(this.COLORS.tertiaryText)
                  .margin({ left: 4, right: 4 })
              }
            }
          }, (item: PathItem) => item.path)
        }
        .padding({ left: 16, right: 16 })
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .width('100%')
      .height(40)
      .backgroundColor(this.COLORS.surfaceVariant)

      Divider()
        .color(this.COLORS.divider)

      // æŽ’åºæ 
      Row() {
        Row() {
          Text('åç§° ' + this.getSortIcon('name'))
            .fontSize(13)
            .fontColor(this.controller.sortField === 'name'
              ? this.COLORS.accent
              : this.COLORS.tertiaryText)
            .fontWeight(this.controller.sortField === 'name'
              ? FontWeight.Medium
              : FontWeight.Normal)
            .onClick(() => {
              this.changeSortField('name');
            })
        }
        .layoutWeight(3)

        Row() {
          Text('å¤§å° ' + this.getSortIcon('size'))
            .fontSize(13)
            .fontColor(this.controller.sortField === 'size'
              ? this.COLORS.accent
              : this.COLORS.tertiaryText)
            .fontWeight(this.controller.sortField === 'size'
              ? FontWeight.Medium
              : FontWeight.Normal)
            .onClick(() => {
              this.changeSortField('size');
            })
        }
        .layoutWeight(2)
        .justifyContent(FlexAlign.End)

        Row() {
          Text('ä¿®æ”¹æ—¥æœŸ ' + this.getSortIcon('date'))
            .fontSize(13)
            .fontColor(this.controller.sortField === 'date'
              ? this.COLORS.accent
              : this.COLORS.tertiaryText)
            .fontWeight(this.controller.sortField === 'date'
              ? FontWeight.Medium
              : FontWeight.Normal)
            .onClick(() => {
              this.changeSortField('date');
            })
        }
        .layoutWeight(2)
        .justifyContent(FlexAlign.End)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 8, bottom: 8 })
      .backgroundColor(this.COLORS.surface)

      Divider()
        .color(this.COLORS.divider)

      // æ–‡ä»¶åˆ—è¡¨
      if (this.controller.sortedResources.length === 0) {
        Column() {
          Text('ðŸ“‚')
            .fontSize(48)
            .margin({ bottom: 12 })

          Text('æ­¤æ–‡ä»¶å¤¹ä¸ºç©º')
            .fontSize(16)
            .fontColor(this.COLORS.tertiaryText)
        }
        .width('100%')
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .backgroundColor(this.COLORS.background)
      } else {
        List({ space: 0 }) {
          ForEach(this.controller.sortedResources, (resource: WebDAVResource, index: number) => {
            ListItem() {
              Row() {
                // å›¾æ ‡å’Œåç§°
                Row({ space: 12 }) {
                  Text(this.getFileIcon(resource))
                    .fontSize(24)

                  Column() {
                    Text(resource.displayName)
                      .fontSize(15)
                      .maxLines(1)
                      .textOverflow({ overflow: TextOverflow.Ellipsis })
                      .fontColor(resource.isCollection
                        ? this.COLORS.accent
                        : this.COLORS.primaryText)
                      .width('100%')
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)
                }
                .layoutWeight(3)
                .alignItems(VerticalAlign.Center)

                // æ–‡ä»¶å¤§å°
                Text(resource.isCollection ? '-' : this.formatFileSize(resource.size))
                  .fontSize(13)
                  .fontColor(this.COLORS.tertiaryText)
                  .layoutWeight(2)
                  .textAlign(TextAlign.End)
                  .maxLines(1)

                // ä¿®æ”¹æ—¥æœŸ
                Text(this.formatDate(resource.lastModified))
                  .fontSize(13)
                  .fontColor(this.COLORS.tertiaryText)
                  .layoutWeight(2)
                  .textAlign(TextAlign.End)
                  .maxLines(1)
              }
              .width('100%')
              .padding({ left: 16, right: 16, top: 12, bottom: 12 })
              .backgroundColor(index % 2 === 0
                ? this.COLORS.background
                : this.COLORS.surface)
            }
            .onClick(() => {
              this.handleResourceClick(resource);
            })
          }, (resource: WebDAVResource) => resource.href)
        }
        .width('100%')
        .layoutWeight(1)
        .backgroundColor(this.COLORS.background)
        .divider({
          strokeWidth: 0.5,
          color: this.COLORS.divider,
          startMargin: 16,
          endMargin: 16
        })
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor(this.COLORS.background)
  }
}